# 카프카 기초

# 카프카를 구성하는 요소
1. ZooKeeper : 아파치 프로젝트 애플리케이션 이름으로 카프카의 메타데이터 관리 및 브로커의 정상상태(health check) 점검을 담당한다.
2. Kafka 또는 Kafka Cluster : 아파치 프로젝트 애플리케이션 이름으로 여러대의 브로커를 구성한 클러스터를 의미
3. Broker : 카프카 애플리케이션이 설치된 서버 또는 노드
4. Producer : 카프카로 메시지를 보내는 역할을 하는 클라이언트 총칭
5. Consumer : 카프카로 메시지를 꺼내가는 역할을 하는 클라이언트 총칭
6. Topic : 카프카는 메시지 피드들을 토픽으로 구분하고, 각 토픽의 이름은 카프카 내에서 고유하다.
7. Partition : 벙렬 처리 및 고성능을 얻기 위해 하나의 토픽을 여러 개로 나눈 것을 말한다.
8. Segment : 프로듀서가 전송한 실제 메시지가 브로커의 로컬 디스크에 저장되는 파일
9. Message 또는 Record : 프로듀서가 브로커로 전송하거나 컨슈머가 읽어가는 데이터 조각

<br>

# Replication(리플리케이션)
각 메시지들을 여러 개로 복사해서 카프카 클러스터 내 브로커들에게 분산키는 동작을 의미
이 덕분에 예기치 않게 브로커가 종료 되더라도 안정성을 유지할 수 있다.

--replication-factor 3 이라는 옵션을 통해 리플리케이션 수를 지정할 수 있다. 

factor가 많아지면 그 만큼 안정성을 유지할 수 있지만, 그 만큼 리소스를 많이 사용하게 되어, 오버헤드가 발생할 수 있으므로, 효율적으로 사용하길 권장한다.

### **추천 Factor** 
- 테스트나 개발 환경 : 1
- 운영 환경(로그성 메시지로 약간의 유실허용) : 2
- 운영 환경(유실 허용X) : 3

<br>

# Partition(파티션)
1. 하나의 토픽이 한 번에 처리할 수 있는 한계를 높이기 위해 토픽 하나를 여러개로 나눠 병렬 처리가 가능하도록 만든 것,
2. 파티션의 수 만큼 Consumer를 연결 할 수 있다.
3. 파티선 번호는 0부터 시작 
4. 파티션은 언제든지 수정할 수 있으므로, 초기에는 2~4정도 생성 후, Consumer LAG등 모니터링 하면서 조금씩 늘려가는 것을 추천
5. LAG란, Producer가 보낸 메시지 수(카프카에 남아 있는 메시지 수) - Consumer가 가져간 메지시 수<br>예를 들어 Producer 5개의 메시지를 카프카로 전송했는데, Consumer 4개를 가져갔다면 5 - 4 = 1 으로 LAG = 1이 된다. <br> 모든 메시지를 가져 갔다면 5-5=0 으로 LAG라는 지표를 통해 지연이 없는지 확인 할 수 있다.
6. 적절한 파티션 수 계산 사이트 https://eventsizer.io를 참고
<br>  

![](01.jpg)

<br>

# Segment
Producer에 의해 브로커로 전송된 메시지를 Topic 의 Partition에 저장되며, 각 메시지는 Segment라는 로그 파일 형태로 브로커의 로컬 디스크에 저장된다.

### **흐름도 구조**
![](02.jpg)